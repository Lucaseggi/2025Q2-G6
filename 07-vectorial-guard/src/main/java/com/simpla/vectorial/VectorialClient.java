package com.simpla.vectorial;

import com.simpla.vectorial.proto.VectorialServiceGrpc;
import com.simpla.vectorial.proto.StoreRequest;
import com.simpla.vectorial.proto.StoreResponse;
import com.simpla.vectorial.proto.SearchRequest;
import com.simpla.vectorial.proto.SearchResponse;
import com.simpla.vectorial.proto.SearchResult;
import io.grpc.Channel;
import io.grpc.ManagedChannel;
import io.grpc.ManagedChannelBuilder;
import io.grpc.StatusRuntimeException;

import java.util.concurrent.TimeUnit;
import java.util.List;
import java.util.Map;

public class VectorialClient {
    private final VectorialServiceGrpc.VectorialServiceBlockingStub blockingStub;

    public VectorialClient(Channel channel) {
        blockingStub = VectorialServiceGrpc.newBlockingStub(channel);
    }

    public void store(String data) {
        System.out.println("Calling store() with data: " + data);

        StoreRequest request = StoreRequest.newBuilder()
                .setData(data)
                .build();

        StoreResponse response;
        try {
            response = blockingStub.store(request);
        } catch (StatusRuntimeException e) {
            System.err.println("RPC failed: " + e.getStatus());
            return;
        }

        System.out.println("Response - Success: " + response.getSuccess() + ", Message: " + response.getMessage());
    }

    public void search(List<Double> embedding, Map<String, String> filters, int limit) {
        System.out.println("Calling search() with embedding size: " + embedding.size() + ", filters: " + filters + ", limit: " + limit);

        SearchRequest.Builder requestBuilder = SearchRequest.newBuilder()
                .addAllEmbedding(embedding)
                .setLimit(limit);

        // Add filters if provided
        if (filters != null) {
            requestBuilder.putAllFilters(filters);
        }

        SearchRequest request = requestBuilder.build();

        SearchResponse response;
        try {
            response = blockingStub.search(request);
        } catch (StatusRuntimeException e) {
            System.err.println("RPC failed: " + e.getStatus());
            return;
        }

        System.out.println("Response - Success: " + response.getSuccess() + ", Message: " + response.getMessage());
        System.out.println("Results count: " + response.getResultsCount());

        for (SearchResult result : response.getResultsList()) {
            String documentType = result.getMetadataMap().get("document_type");
            String infolegId = result.getMetadataMap().get("infoleg_id");
            String divisionIndex = result.getMetadataMap().get("division_index");
            String articleIndex = result.getMetadataMap().get("article_index");

            System.out.println("=== Search Result ===");
            System.out.println("Document ID: " + result.getDocumentId());
            System.out.println("Score: " + result.getScore());
            System.out.println("Type: " + documentType);
            System.out.println("Infoleg ID: " + infolegId);

            if ("division".equals(documentType)) {
                String divisionName = result.getMetadataMap().get("division_name");
                String divisionOrdinal = result.getMetadataMap().get("division_ordinal");
                System.out.println("Division Index: " + divisionIndex);
                System.out.println("Division Name: " + divisionName);
                System.out.println("Division Ordinal: " + divisionOrdinal);
            } else if ("article".equals(documentType)) {
                String articleOrdinal = result.getMetadataMap().get("article_ordinal");
                System.out.println("Division Index: " + divisionIndex);
                System.out.println("Article Index: " + articleIndex);
                System.out.println("Article Ordinal: " + articleOrdinal);
            }

            System.out.println("All Metadata: " + result.getMetadataMap());
            System.out.println();
        }
    }

    public static void main(String[] args) throws Exception {
        String target = "localhost:50052"; // Default vectorial-guard port
        if (args.length > 0) {
            target = args[0];
        }

        ManagedChannel channel = ManagedChannelBuilder.forTarget(target)
                .usePlaintext()
                .build();

        try {
            VectorialClient client = new VectorialClient(channel);

            // Test the search method with a sample embedding
            // This is a sample embedding - replace with the actual embedding you want to test
            List<Double> testEmbedding = List.of(
                    0.0136140585,
                    0.02117191,
                    0.016825264,
                    -0.07473897,
                    0.0026636682,
                    0.028916612,
                    0.02066166,
                    0.00873575,
                    -0.0061048116,
                    -0.028966635,
                    0.00037325843,
                    0.020047275,
                    0.04698321,
                    0.0003848891,
                    0.13521788,
                    -0.002392769,
                    -0.0085663535,
                    -0.017851783,
                    -0.01620613,
                    -0.014017963,
                    0.015332394,
                    -0.008552289,
                    0.001620303,
                    0.028193682,
                    -0.009624782,
                    0.011703895,
                    -0.016894994,
                    -0.0155605115,
                    0.028979184,
                    -0.02997205,
                    0.0066593844,
                    0.013543706,
                    0.002021611,
                    -0.0009456506,
                    0.016588567,
                    0.015457736,
                    0.01714438,
                    -0.014260537,
                    0.0015883577,
                    -0.00082901015,
                    -0.017509628,
                    0.006967741,
                    -0.008051443,
                    -0.016617274,
                    0.020681426,
                    -0.0083060125,
                    0.011471268,
                    -0.027259216,
                    -0.026201652,
                    0.015452466,
                    -0.013619382,
                    -0.020914434,
                    -0.001732927,
                    -0.17669044,
                    0.015884848,
                    0.007805884,
                    0.0070991986,
                    -0.022367653,
                    0.00054142775,
                    -0.033285066,
                    -0.019158976,
                    0.05206867,
                    -0.01544347,
                    -0.018153684,
                    -0.021734009,
                    0.008195696,
                    -0.009595771,
                    0.020124748,
                    -0.0062671728,
                    -0.036634695,
                    0.02910893,
                    0.013083629,
                    0.010924134,
                    0.006080371,
                    0.01318907,
                    0.0066362647,
                    0.0063116783,
                    -0.016313618,
                    0.011760817,
                    -0.00058985146,
                    0.00046938463,
                    0.002478775,
                    0.007748004,
                    -0.017416107,
                    -0.007925867,
                    -0.008048127,
                    -0.008361582,
                    -0.0126198465,
                    0.029185154,
                    0.024012169,
                    0.017050147,
                    -0.024072867,
                    0.0077106254,
                    -0.0008243907,
                    -0.020152899,
                    0.010405732,
                    0.0005796269,
                    -0.016953602,
                    -0.025842657,
                    -0.025369857,
                    -0.03012775,
                    0.005489575,
                    -0.00909167,
                    -0.025059786,
                    0.019400002,
                    -0.028089786,
                    0.025858836,
                    0.018098202,
                    0.01737151,
                    -0.003228571,
                    -0.016377598,
                    -0.021592766,
                    -0.013626259,
                    0.0073234164,
                    -0.012157783,
                    -0.10334894,
                    -0.0044867075,
                    -0.0033257792,
                    -0.0096495235,
                    -0.0032607538,
                    0.014124917,
                    0.002364609,
                    0.00077490974,
                    0.013078262,
                    0.01775597,
                    -0.019303331,
                    0.0004670292,
                    -0.011620729,
                    0.008015184,
                    -0.011257674,
                    0.024159182,
                    -0.014327935,
                    -0.0051113875,
                    -0.022526126,
                    -0.002940488,
                    -0.0006644701,
                    -0.01419368,
                    -0.014855033,
                    0.029874694,
                    -0.024063766,
                    0.0019298331,
                    -0.014636136,
                    -0.0043148682,
                    -0.011859464,
                    -0.009596316,
                    -0.0075019714,
                    -0.020087438,
                    -0.0028904502,
                    -0.011811807,
                    -0.00079866033,
                    0.005045019,
                    -0.029857758,
                    -0.017194243,
                    -0.0035964553,
                    -0.014054374,
                    -0.040378176,
                    0.0204694,
                    -0.009424492,
                    -0.008256127,
                    -0.0031130244,
                    -0.015936907,
                    0.0019024125,
                    -0.0141995605,
                    0.0069595957,
                    0.012805777,
                    0.021461518,
                    -0.00840248,
                    -0.01694382,
                    0.0009586635,
                    0.024351893,
                    0.0056166253,
                    -0.000768354,
                    -0.009798968,
                    -0.0076904832,
                    0.016209248,
                    0.00021887431,
                    -0.004181104,
                    0.007012065,
                    -0.016545204,
                    -0.012233745,
                    0.00055476365,
                    0.0017367554,
                    0.024039153,
                    0.014461925,
                    0.03343761,
                    -0.016758801,
                    -0.027115671,
                    0.010453525,
                    0.007920322,
                    0.005117901,
                    -0.016435277,
                    0.011586581,
                    -0.030491844,
                    -0.0012913881,
                    -0.010468044,
                    -0.022974186,
                    -0.020223962,
                    -0.0068632863,
                    -0.027763037,
                    -0.00043026992,
                    0.018023903,
                    -0.008737727,
                    0.03076784,
                    -0.009428582,
                    -0.026375651,
                    -0.005299096,
                    -0.018348843,
                    -0.012374982,
                    -0.02473088,
                    0.01618877,
                    -0.00073273346,
                    0.007815771,
                    0.007784801,
                    -0.037741538,
                    0.015447034,
                    -0.036409914,
                    0.007303723,
                    -0.007218729,
                    -0.011072467,
                    -0.0019998257,
                    0.032420196,
                    -0.002025692,
                    -0.01300101,
                    0.014084103,
                    -0.008437821,
                    -0.00371913,
                    -0.016998302,
                    0.016790226,
                    -0.001511133,
                    -0.012910391,
                    0.027596233,
                    0.00977855,
                    0.0007521824,
                    0.023491725,
                    0.0033584784,
                    -0.038271204,
                    0.010583511,
                    -0.022639308,
                    0.008844278,
                    0.016027702,
                    -0.01991596,
                    0.00294687,
                    -0.028174028,
                    -0.0012571921,
                    -0.01416814,
                    0.02639815,
                    -0.011701497,
                    -0.02440861,
                    -0.020195028,
                    0.026538989,
                    0.0076641403,
                    0.033677842,
                    -0.0068300758,
                    0.0067871595,
                    -0.032666694,
                    0.0039998447,
                    -0.01080259,
                    -0.0034954958,
                    -0.015123355,
                    0.011871753,
                    0.024062768,
                    -0.023283279,
                    -0.023111016,
                    0.025700187,
                    0.0027686905,
                    0.0070169484,
                    0.0059796884,
                    -0.016535515,
                    -0.0037287849,
                    -0.026781658,
                    0.022117803,
                    -0.019410502,
                    0.0012089593,
                    -0.024565237,
                    0.0013622752,
                    0.01768896,
                    -0.049770836,
                    0.022698928,
                    0.0057836575,
                    -0.013856853,
                    -0.027809458,
                    -0.0033028491,
                    0.0034263139,
                    0.0048290305,
                    -0.020888066,
                    0.010888009,
                    0.014011672,
                    -0.005362269,
                    -0.00972996,
                    -0.005379065,
                    0.0115324175,
                    0.008543525,
                    -0.025280897,
                    -0.015899666,
                    0.0056045637,
                    -0.003806053,
                    -0.0007979587,
                    -0.0032874243,
                    0.019297374,
                    -0.04243139,
                    0.03091422,
                    0.00973505,
                    0.019058215,
                    0.03559275,
                    0.0143993795,
                    0.010704062,
                    0.01358402,
                    0.0030763473,
                    -0.0074736015,
                    -0.00273973,
                    0.014891654,
                    0.0056046457,
                    -0.03381328,
                    0.0046103015,
                    -0.009094595,
                    0.021367071,
                    0.015892113,
                    -0.026472192,
                    -0.008592502,
                    -0.013529607,
                    0.009819494,
                    -0.01565747,
                    -0.023341276,
                    0.017645627,
                    0.007998686,
                    0.0036026991,
                    -0.0064771683,
                    -0.029040039,
                    0.014165302,
                    0.028183691,
                    -0.012592088,
                    0.010327144,
                    0.013233809,
                    0.008182807,
                    0.0066371695,
                    0.0076984093,
                    0.010162296,
                    -0.003713881,
                    0.01661202,
                    0.021728026,
                    0.0003495872,
                    -0.025113404,
                    -0.005019426,
                    -0.009854807,
                    0.017080354,
                    0.046687897,
                    -0.0072194724,
                    -0.04105659,
                    -0.019086724,
                    -0.020594554,
                    -0.0020513043,
                    0.0032160264,
                    -0.007199538,
                    -0.008290224,
                    0.012183802,
                    0.02104518,
                    0.009207816,
                    0.0031734034,
                    0.011086038,
                    -0.017451508,
                    0.00012768549,
                    0.010864809,
                    0.012414388,
                    0.0066373423,
                    -0.0019213593,
                    -0.0040636393,
                    -0.009173588,
                    -0.002727605,
                    0.011491383,
                    -0.01224194,
                    -0.012673678,
                    -0.013301582,
                    -0.029088104,
                    -0.021966197,
                    -0.0024964875,
                    0.013893735,
                    -0.02434857,
                    -0.006678529,
                    0.0009823899,
                    -0.011348077,
                    0.010757204,
                    -0.034674928,
                    -0.0073559196,
                    0.02121703,
                    -0.011101967,
                    -0.0185817,
                    0.007047569,
                    -0.0005173424,
                    0.012291964,
                    0.008889895,
                    0.007280934,
                    -0.013117268,
                    0.0028431602,
                    0.012272848,
                    -0.018731702,
                    -0.0129055735,
                    0.009447853,
                    -0.0031193048,
                    0.009713698,
                    0.0263566,
                    0.011392749,
                    -0.03037007,
                    0.0018681358,
                    -0.0101334015,
                    -0.0076655606,
                    -0.012510024,
                    -0.031357527,
                    -0.007724144,
                    -0.013466111,
                    -0.015719753,
                    0.011201832,
                    -0.026849305,
                    0.008306047,
                    0.023359414,
                    0.034238268,
                    0.011696369,
                    9.2870316e-05,
                    -0.003679942,
                    -0.0035995438,
                    0.015939923,
                    -0.02024052,
                    0.00032548187,
                    -0.021380132,
                    0.03594158,
                    -0.006576024,
                    0.007213837,
                    0.0030052601,
                    0.011262085,
                    0.016363787,
                    -0.005487514,
                    0.003770128,
                    -0.00472781,
                    -0.019214556,
                    -0.015849404,
                    0.026534835,
                    0.009407901,
                    -0.010315441,
                    -0.009250638,
                    -0.019257346,
                    0.013456068,
                    0.0042987447,
                    0.026343185,
                    0.009549458,
                    -0.004314151,
                    0.028010659,
                    -0.008582015,
                    -0.005800003,
                    -0.010907139,
                    0.0055517727,
                    -0.004203027,
                    0.019383209,
                    0.014601875,
                    0.013277182,
                    0.0013650655,
                    -0.015618339,
                    0.009690124,
                    -0.011863693,
                    0.018667754,
                    0.02006614,
                    0.016541073,
                    -0.005440486,
                    -0.04484135,
                    -0.0066126366,
                    0.012706486,
                    -0.0043575293,
                    0.006683806,
                    0.006347193,
                    -0.018132575,
                    0.017201992,
                    0.023299752,
                    -0.04005195,
                    0.008878562,
                    0.002740118,
                    0.008680299,
                    -0.00418416,
                    0.016102776,
                    -0.026752515,
                    -0.032164536,
                    -0.007104707,
                    -0.0024037033,
                    -0.008872375,
                    0.014315035,
                    -0.022611229,
                    0.010643773,
                    0.026128856,
                    0.014579181,
                    0.003338643,
                    0.0009370365,
                    0.019500168,
                    0.018527774,
                    0.01245871,
                    0.035037242,
                    -0.012375033,
                    -0.03125819,
                    -0.000227255,
                    -0.0031267866,
                    -0.016738214,
                    0.006976518,
                    0.018030193,
                    0.008625871,
                    -0.001946495,
                    0.030179795,
                    -0.016558742,
                    -0.00490145,
                    -0.0132992985,
                    0.020083677,
                    -0.012480363,
                    0.0081805615,
                    0.04927281,
                    0.015498167,
                    -0.010378487,
                    0.0059095435,
                    -0.0006596465,
                    -0.017866554,
                    0.027716687,
                    0.008519015,
                    0.024889067,
                    0.04030665,
                    0.00029733006,
                    0.011465882,
                    -0.004239059,
                    0.007062342,
                    0.00995757,
                    0.005252002,
                    -0.019236267,
                    0.03629121,
                    -0.022005789,
                    -0.026913565,
                    -0.0030752795,
                    0.007300601,
                    -0.019585958,
                    0.0022697612,
                    0.0024952923,
                    0.021841431,
                    -0.00046848803,
                    0.0014616316,
                    -0.0009780823,
                    0.01696854,
                    0.0047363723,
                    -0.0060998728,
                    -0.009639032,
                    -0.0400992,
                    -0.03465442,
                    -0.023235193,
                    -0.001967759,
                    -0.10063637,
                    0.017292058,
                    0.0076976735,
                    -0.0013600718,
                    -0.021109313,
                    0.0072128316,
                    0.023542851,
                    -0.0031753099,
                    -0.00969915,
                    0.012755837,
                    -0.007916485,
                    0.006548663,
                    0.0056119487,
                    0.014405387,
                    -0.03725373,
                    0.0071472283,
                    0.01496524,
                    0.0012833464,
                    0.02812796,
                    0.021179603,
                    -0.017371915,
                    0.018576598,
                    -0.0014492489,
                    0.01150075,
                    -0.0067821536,
                    0.0385992,
                    -0.0036670887,
                    -0.004561456,
                    0.010206717,
                    0.033242673,
                    -0.0091886725,
                    -0.014651292,
                    -0.0032405618,
                    0.021267349,
                    0.00018873857,
                    -0.021013768,
                    -0.004024737,
                    -0.009249785,
                    0.0052230777,
                    0.006892575,
                    -0.024370356,
                    0.017839042,
                    0.016823169,
                    -0.005288961,
                    -0.040688682,
                    -0.01095444,
                    -0.017856045,
                    0.023928994,
                    0.009851123,
                    0.008889404,
                    0.0059666703,
                    -0.012992054,
                    -0.00013246047,
                    -0.03064468,
                    -0.026278745,
                    -0.050621603,
                    -0.0047359485,
                    -0.027853476,
                    -0.022954911,
                    -0.014039957,
                    0.0049986783,
                    0.0020549106,
                    0.020122731,
                    -0.01053171,
                    0.0017589147,
                    -0.013384724,
                    -0.041935552,
                    -0.002634276,
                    -0.004486631,
                    0.03622103,
                    -0.022386681,
                    0.0063824146,
                    0.010269793,
                    -0.0026851632,
                    0.00899996,
                    0.003451533,
                    0.004284691,
                    0.03454762,
                    0.056772005,
                    0.016432796,
                    -0.03101602,
                    0.048216354,
                    -0.11138965,
                    0.03263791,
                    0.00044128188,
                    0.00031166873,
                    -0.02474075,
                    -0.010956483,
                    -0.00085555535,
                    -0.03718753,
                    0.0022313315,
                    -0.004850301,
                    0.010104658,
                    0.027824832,
                    -0.01312501,
                    -0.01625898,
                    -0.021744752,
                    -0.006667898,
                    0.0002999489,
                    -0.010226707,
                    -0.017212065,
                    -0.004065072,
                    -0.027339118,
                    0.0053008264,
                    -0.0030734225,
                    -0.019351244,
                    -0.009287098,
                    -0.019425888,
                    0.01139699,
                    -0.0024916208,
                    0.040779024,
                    -0.038238257,
                    -0.037374828,
                    -0.14016946,
                    -0.0022268784,
                    -0.010319088,
                    -0.00522877,
                    0.000675879,
                    0.023277009,
                    0.0057609067,
                    0.007869466,
                    -0.0013346414,
                    -0.0047265785,
                    -0.0035040295,
                    0.021501986,
                    -0.00074457156,
                    -0.007041728,
                    0.023059925,
                    0.09826618,
                    0.003085556,
                    -0.012352975,
                    -0.007992539,
                    0.019207736,
                    0.020501,
                    0.014182934,
                    0.008120234,
                    0.009086026,
                    -0.0048242644,
                    -0.014200649,
                    0.02671842,
                    0.003937965,
                    0.0012715774,
                    -0.020115037,
                    -0.004900731,
                    -0.015506287,
                    0.021368232,
                    0.023153324,
                    0.017659262,
                    -0.011352035,
                    -0.0005471564,
                    -0.006257177,
                    -0.029530153,
                    -0.014251126,
                    0.01690427,
                    0.008856669,
                    -0.003138796,
                    -0.02238617,
                    -0.020349588,
                    -0.009442186,
                    0.010692721,
                    0.00062635145,
                    -0.0053034956,
                    -0.0050009843,
                    -0.009626403,
                    -0.058298122,
                    0.0315537,
                    0.02031353,
                    -0.0043921354,
                    0.048996698,
                    -0.011228971,
                    -0.004040637,
                    0.01212827,
                    0.020975523,
                    0.033079494,
                    -0.02883988,
                    0.0090174535,
                    0.0025191878,
                    -0.027261876,
                    -0.0075030215,
                    0.020186175,
                    0.002601441,
                    -0.007320584,
                    0.04713788,
                    0.013834205,
                    0.017793002,
                    -0.022043647,
                    -0.0084542,
                    0.0076389126,
                    -0.041560166,
                    -0.0097039975,
                    0.0048248465,
                    -0.015478069,
                    0.03187039,
                    0.009206513,
                    0.011819333,
                    0.022849305,
                    0.0149122765,
                    -0.0017551775,
                    -0.0004918495,
                    0.008144737,
                    -0.013318698,
                    0.002337569,
                    -0.013240187,
                    0.001979301,
                    0.018094918,
                    0.028835021,
                    -0.025319995,
                    0.019397164,
                    0.004200552,
                    0.010309497,
                    0.017326904,
                    -0.015870173,
                    -0.031583413,
                    0.009770494,
                    0.007892281,
                    -0.0026539168,
                    0.008593731,
                    -0.009288538,
                    -0.0015834479,
                    0.02713657,
                    -0.012206831,
                    0.009120928,
                    0.013142072
                // Add more values up to the expected embedding dimension (typically 768 or 1536)
            );

            // Test search without filters
            System.out.println("=== Testing search without filters ===");
            client.search(testEmbedding, null, 1);

            // Test search with filters
            System.out.println("\n=== Testing search with filters ===");
            Map<String, String> filters = Map.of(
                "document_type", "division",
                "infoleg_id", "183532"
            );
            client.search(testEmbedding, filters, 1);

        } finally {
            channel.shutdownNow().awaitTermination(5, TimeUnit.SECONDS);
        }
    }
}